// Generated by CoffeeScript 1.7.0
(function() {
  var Roots, Server, default_port, on_done, on_error, on_start, open, path;

  open = require('open');

  path = require('path');

  Roots = require('../');

  Server = require('../local_server');

  default_port = 1111;

  module.exports = function(args, cli) {
    var dir, opts, project, server, w;
    dir = args._[1] ? path.resolve(args._[1]) : process.cwd();
    opts = {
      env: args.env || 'development'
    };
    project = new Roots(dir, opts);
    if (args.open == null) {
      args.open = true;
    }
    cli.emit('inline', 'compiling... '.grey);
    server = new Server(project, dir);
    server.start(process.env.port || default_port);
    w = project.watch();
    w.on('start', function() {
      return on_start(cli, server);
    });
    w.on('error', function(err) {
      return on_error(cli, server, err);
    });
    w.on('done', function() {
      return on_done(cli, server);
    });
    w.once('done', function() {
      if (project.config.open_browser && args.open) {
        return open("http://localhost:" + (process.env.port || default_port) + "/");
      }
    });
    return w;
  };

  on_error = function(cli, server, err) {
    cli.emit('err', Error(err).stack);
    return server.show_error(Error(err).stack);
  };

  on_start = function(cli, server) {
    cli.emit('inline', 'compiling... '.grey);
    return server.compiling();
  };

  on_done = function(cli, server) {
    cli.emit('inline', 'done!\n'.green);
    return server.reload();
  };

}).call(this);
